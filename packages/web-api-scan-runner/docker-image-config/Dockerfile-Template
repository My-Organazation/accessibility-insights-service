# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
FROM node:12-slim

# Set Environment variables
ENV APPINSIGHTS_INSTRUMENTATIONKEY=%APP_INSIGHTS_TOKEN%
ENV AZURE_STORAGE_SCAN_QUEUE=ondemand-scanrequest
ENV AZURE_STORAGE_NOTIFICATION_QUEUE=ondemand-send-notification
ENV KEY_VAULT_URL=%KEY_VAULT_TOKEN%

# Copy configuration
COPY runtime-config*.json ./

# Install Chrome
RUN dpkg --configure -a \
    && apt-get update \
    && apt-get install -y wget gnupg \
    && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
    && sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >/etc/apt/sources.list.d/google.list' \
	&& apt-get update && apt-get install -y google-chrome-stable

# Install app dependencies
COPY package*.json ./
RUN npm install

# Bundle app source
COPY . .

ENTRYPOINT [ "node", "./web-api-scan-runner.js" ]
CMD [${arg}]
